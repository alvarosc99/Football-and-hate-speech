---
title: "3 - Visualization"
author: "Alejandro Aísa, Álvaro Sanz"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(ggplot2)
library(data.table)
library(lubridate)
library(showtext)
```


# Importing the data

```{r}
#dfull <- read.csv("data/predicted.csv")
dfull <- fread("data/predicted.csv")
```

# Data transforming

```{r}
min(dfull$created_at)
max(dfull$created_at)
```

```{r}

dfull <- dfull %>% 
  mutate(created_at = ymd_hms(created_at),
         created_at = format(created_at, "%Y-%m-%d %H:00:00"))

viz <- dfull %>% 
  mutate(hate = factor(hate, levels = c("No", "Yes"))) %>% 
  group_by(created_at) %>% 
  summarise(No_count = sum(hate == "No", na.rm = TRUE),
            Yes_count = sum(hate == "Yes", na.rm = TRUE),
            Total = sum(No_count, Yes_count),
            Proportion = Yes_count/Total * 100)

```

```{r}
viz <- viz %>% 
  mutate(match = case_when(created_at == "2022-11-23 15:00:00" | created_at == "2022-11-23 16:00:00" | created_at == "2022-11-23 17:00:00" | created_at == "2022-11-23 18:00:00" | created_at == "2022-11-23 19:00:00" | created_at == "2022-11-23 20:00:00" | created_at == "2022-11-23 21:00:00" | created_at == "2022-11-23 17:00:00" | created_at == "2022-11-27 18:00:00" | created_at == "2022-11-27 19:00:00" | created_at == "2022-11-27 20:00:00" | created_at == "2022-11-27 21:00:00" | created_at == "2022-11-27 22:00:00" | created_at == "2022-11-27 23:00:00" | created_at == "2022-11-27 24:00:00" | created_at == "2022-12-01 18:00:00" | created_at == "2022-12-01 19:00:00" | created_at == "2022-12-01 20:00:00" | created_at == "2022-12-01 21:00:00" | created_at == "2022-12-01 22:00:00" | created_at == "2022-12-01 23:00:00" | created_at == "2022-12-01 24:00:00" | created_at == "2022-12-06 14:00:00" | created_at == "2022-12-06 15:00:00" | created_at == "2022-12-06 16:00:00" | created_at == "2022-12-06 17:00:00" | created_at == "2022-12-06 18:00:00" | created_at == "2022-12-06 19:00:00" ~ 1,
                           T ~ 0),
         match = factor(match, levels = c(0,1)), 
         costarica = factor(ifelse((match == 1 & day(created_at) == 23), 1, 0), levels = c(0,1)),
         germany = factor(ifelse((match == 1 & day(created_at) == 27), 1, 0), levels = c(0,1)),
         japan = factor(ifelse((match == 1 & day(created_at) == 01), 1, 0), levels = c(0,1)),
         morocco = factor(ifelse((match == 1 & day(created_at) == 06), 1, 0), levels = c(0,1)))
```

# Visualization

```{r}
sysfonts::font_add_google("Titillium Web", family="titillium")
showtext::showtext_auto()
```


```{r}

vizjap <- viz %>% 
  filter(match == 1 & japan == 1)
vizcr <- viz %>% 
  filter(match == 1 & costarica == 1)
vizger <- viz %>% 
  filter(match == 1 & germany == 1)
vizmor <- viz %>% 
  filter(match == 1 & morocco == 1)



viz %>% 
  ggplot() +
  aes(x = as.POSIXct(created_at), y = Proportion) +
  geom_rect(aes(xmin=as.POSIXct("2022-11-23 15:00"), xmax=as.POSIXct("2022-11-23 21:00"), ymin=(-Inf), ymax=Inf),
            alpha=0.1, show.legend=FALSE, fill = "lightgrey") + #Costa Rica
  geom_rect(aes(xmin=as.POSIXct("2022-11-27 18:00"), xmax=as.POSIXct("2022-11-28 00:00"), ymin=(-Inf), ymax=Inf),
            alpha=0.1, show.legend=FALSE, fill = "lightgrey") + #Germany
  geom_rect(aes(xmin=as.POSIXct("2022-12-01 18:00"), xmax=as.POSIXct("2022-12-02 00:00"), ymin=(-Inf), ymax=Inf),
            alpha=0.1, show.legend=FALSE, fill = "lightgrey") + #Japan
  geom_rect(aes(xmin=as.POSIXct("2022-12-06 14:00"), xmax=as.POSIXct("2022-12-06 19:00"), ymin=(-Inf), ymax=Inf),
            alpha=0.01, show.legend=FALSE, fill = "lightgrey") + #Morocco
  geom_line() +
  geom_line(data = vizjap, aes(x = as.POSIXct(created_at), y = Proportion), color = "orange") +
  geom_line(data = vizcr, aes(x = as.POSIXct(created_at), y = Proportion), color = "orange") +
  geom_line(data = vizger, aes(x = as.POSIXct(created_at), y = Proportion), color = "orange") +
  geom_line(data = vizmor, aes(x = as.POSIXct(created_at), y = Proportion), color = "orange") +
  scale_color_manual(aes(match), values = c("black", "orange")) +
  scale_y_continuous(
    limits = c(0,6),
    labels = function(x) paste0(x, "%")) +
  scale_x_datetime(date_labels = "%d/%m %Hh", date_breaks = "12 hours") +
  theme(axis.ticks.x.bottom = element_blank(),
        axis.text.x.bottom = element_text(angle = 45, vjust = 0.5),
        text = element_text(family = "titillium", colour = "black"),
        axis.line.y = element_blank(),
        panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_line(colour = "lightgrey", linetype = "dotted"),
        axis.ticks = element_line(color = "lightgrey"),
        panel.background = element_blank(),
        plot.margin = margin(t=0,
                         r=10,
                         b=0,
                         l=0),
        plot.title = element_text(size = 20, face = "bold"),
        plot.subtitle = element_text(size = 14, face = "italic"),
        axis.title = element_text(size = 13),
        axis.title.x = element_text(margin = margin(t = 10)),
        axis.title.y = element_text(margin = margin(r = 10))) +
  ylab("Proportion of hateful tweets") +
  xlab("Time when the tweet was sent") +
  labs(title = "The patterns of Spanish online hate speech",
       subtitle = "The % of hateful tweets increases the days after games, specially when Spain doesn't win and plays against teams from other continents") +
  annotate(
    "text", x = as.POSIXct("2022-11-30 06:00"), y = 5,
    label = "= match",
    color = "black"
  ) +
  annotate(geom = "point", 
           x = as.POSIXct("2022-11-29 00:00"), y = 5, color = "orange", size = 3, shape = 16) +
  annotate(
    "text", x = as.POSIXct("2022-11-30 06:00"), y = 4.5,
    label = "     = no match",
    color = "black"
  ) +
  annotate(geom = "point", 
           x = as.POSIXct("2022-11-29 00:00"), y = 4.5, color = "black", size = 3, shape = 16)
  
vizz
#ggsave("test.jpeg")

```


# Inside Spain vs. Morocco

(Zoomed plot)


# T-tests

All: 

```{r}

s<-split(viz$Proportion,viz$match) #splits the variable price in two groups by gender

#first step: test for equal variances
var.test(s$`0`, s$`1`, alternative = "two.sided")
#second step: test for differences of means, knowing that variances are different
t.test(s$`0`, s$`1` ,alternative="two.sided",mu=0,var.equal=FALSE)  ##The only thing that changes is the last part, var.equal has to be =FALSE. 
##It also gives the difference's confidence interval --> In this case it's + (both values), so males's proportion is greater. 
```

Morocco: 

```{r}

s<-split(viz$Proportion,viz$morocco) #splits the variable price in two groups by gender

#first step: test for equal variances
var.test(s$`0`, s$`1`, alternative = "two.sided")
#second step: test for differences of means, knowing that variances are different
t.test(s$`1`, s$`0`, alternative="greater",mu=0.8,var.equal=TRUE)  ##The only thing that changes is the last part, var.equal has to be =FALSE. 
##It also gives the difference's confidence interval --> In this case it's + (both values), so males's proportion is greater. 
```

Costa Rica: 

```{r}
s<-split(viz$Proportion,viz$morocco) #splits the variable price in two groups by gender

#first step: test for equal variances
var.test(s$`0`, s$`1`, alternative = "two.sided")
#second step: test for differences of means, knowing that variances are different
t.test(s$`1`, s$`0`, alternative="greater",mu=0.8,var.equal=TRUE)  ##The only thing that changes is the last part, var.equal has to be =FALSE. 
##It also gives the difference's confidence interval --> In this case it's + (both values), so males's proportion is greater. 
```

Japan: 

```{r}
s<-split(viz$Proportion,viz$morocco) #splits the variable price in two groups by gender

#first step: test for equal variances
var.test(s$`0`, s$`1`, alternative = "two.sided")
#second step: test for differences of means, knowing that variances are different
t.test(s$`1`, s$`0`, alternative="greater",mu=0.8,var.equal=TRUE)  ##The only thing that changes is the last part, var.equal has to be =FALSE. 
##It also gives the difference's confidence interval --> In this case it's + (both values), so males's proportion is greater. 
```

Germany: 

```{r}
s<-split(viz$Proportion,viz$morocco) #splits the variable price in two groups by gender

#first step: test for equal variances
var.test(s$`0`, s$`1`, alternative = "two.sided")
#second step: test for differences of means, knowing that variances are different
t.test(s$`1`, s$`0`, alternative="greater",mu=0.8,var.equal=TRUE)  ##The only thing that changes is the last part, var.equal has to be =FALSE. 
##It also gives the difference's confidence interval --> In this case it's + (both values), so males's proportion is greater. 
```

